<%- include('partials/head', { title: 'Purchase Order System | Castlerock Homes', styles: ['admin.css', 'po-line-items.css'] }) %>
<%- include('partials/header', { pageTitle: 'Purchase Order System' }) %>

<main class="container">

  <div id="filterPanel" class="card dashboard-filters" style="display:none">

    <div class="filter-row">
      <label>Status</label>
      <select id="statusFilter">
        <option value="all">All</option>
        <option value="outstanding">Outstanding</option>
        <option value="complete">Fully Invoiced</option>
        <option value="over-invoiced">Over-Invoiced</option>
      </select>
      <select id="supplierFilter">
        <option value="">All</option>
      </select>
    </div>

    <div class="filter-row">
      <label>Site</label>
      <select id="siteFilter">
        <option value="">All</option>
      </select>
    </div>

    <div class="filter-row">
      <label>Location</label>
      <select id="locationFilter">
        <option value="">All</option>
      </select>
    </div>

    <div class="filter-row">
      <label>Stage</label>
      <select id="stageFilter">
        <option value="">All</option>
      </select>
    </div>

    <div class="filter-row">
      <label>Date From</label>
      <input type="date" id="dateFrom">
    </div>

    <div class="filter-row">
      <label>Date To</label>
      <input type="date" id="dateTo">
    </div>

    <div class="filter-row">
      <label>Value Min (<span data-currency-symbol>€</span>)</label>
      <input type="number" id="valueMin" step="0.01">
    </div>

    <div class="filter-row">
      <label>Value Max (<span data-currency-symbol>€</span>)</label>
      <input type="number" id="valueMax" step="0.01">
    </div>

    <div class="filter-actions">
      <button class="btn btn-outline-secondary" onclick="toggleFilters()">Close</button>
      <button class="btn btn-outline-secondary" onclick="clearFilters()">Clear Filters</button>
    </div>

  </div>

  <div class="card">
    <div class="dashboard-header">
      <h3 style="margin: 0;">Purchase Orders</h3>
      <div class="dashboard-actions">
        <button class="btn btn-primary" onclick="openCreatePOModal()">
          <i class="bi bi-plus-circle me-1"></i><span class="btn-text">Add PO</span>
        </button>
        <button class="btn btn-outline-secondary" onclick="window.location.href='suppliers.html'">
          <i class="bi bi-building me-1"></i><span class="btn-text">Suppliers</span>
        </button>
        <button class="btn btn-outline-secondary" onclick="toggleFilters()">
          <i class="bi bi-funnel me-1"></i><span class="btn-text">Filters</span>
        </button>
      </div>
    </div>

    <table class="po-table">
      <thead>
        <tr>
          <th>PO Number</th>
          <th>Date</th>
          <th>Supplier</th>
          <th>Location</th>
          <th>Stage</th>
          <th>Net (<span data-currency-symbol>€</span>)</th>
        </tr>
      </thead>
      <tbody id="poTable"></tbody>
    </table>
  </div>

  <div id="totalsBar" class="totals-bar">
    <div>
      <strong>Count:</strong>
      <span id="poCount">0</span>
    </div>
    <div>
      <strong>Total (ex VAT):</strong>
      <span id="totalNet"><span data-currency-symbol>€</span>0.00</span>
    </div>
    <div>
      <strong>Total (inc VAT):</strong>
      <span id="totalGross"><span data-currency-symbol>€</span>0.00</span>
    </div>
  </div>

  <!-- Edit Purchase Order Modal -->
  <div id="editPOModal" class="modal" style="display:none;">
    <div class="modal-dialog modal-dialog-scrollable" style="max-width: 600px;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Purchase Order</h5>
          <button type="button" class="btn-close" aria-label="Close" onclick="closeEditPOModal()"></button>
        </div>
        <form id="editPOForm">
          <div class="modal-body" style="display: flex; flex-direction: column; gap: 1rem;">
        <div>
          <label for="editPONumber" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">PO Number</label>
          <input type="text" id="editPONumber" class="form-control" style="width: 100%;" disabled>
        </div>

        <div>
          <label for="editPOSupplier" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Supplier *</label>
          <select id="editPOSupplier" class="form-select" style="width: 100%;" required>
            <option value="">Select Supplier</option>
          </select>
        </div>

        <div>
          <label for="editPOSite" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Site</label>
          <input type="text" id="editPOSite" class="form-control" style="width: 100%;" disabled>
          <small style="color: #666; font-size: 0.85rem; margin-top: 0.25rem; display: block;">Note the site cannot be changed on an existing PO please delete and create a new one.</small>
        </div>

        <div>
          <label for="editPOLocation" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Location *</label>
          <select id="editPOLocation" class="form-select" style="width: 100%;" required>
            <option value="">Select Location</option>
          </select>
        </div>

        <div>
          <label for="editPOStage" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Stage *</label>
          <select id="editPOStage" class="form-select" style="width: 100%;" required>
            <option value="">Select Stage</option>
          </select>
        </div>

        <div>
          <label for="editPODate" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">PO Date *</label>
          <input type="date" id="editPODate" class="form-control" style="width: 100%;" required>
        </div>

        <div>
          <div class="field-with-toggle" style="margin-top: 0;">
            <label for="editPODescription" style="margin: 0; font-weight: 500;">Description</label>
            <button type="button" id="editPOToggleLineItems" class="btn btn-outline-secondary btn-sm">Add Line Items</button>
          </div>
          <textarea id="editPODescription" class="form-control" placeholder="Enter description" rows="3" style="width: 100%;"></textarea>
        </div>

        <div id="editPOLineItemsSection" class="line-items-section" style="display: none;">
          <div class="table-responsive">
            <table class="table table-sm line-items-table">
            <tbody id="editPOLineItemsBody"></tbody>
            </table>
          </div>
          <div class="line-items-actions">
            <button type="button" id="editPOAddLineItem" class="btn btn-outline-secondary btn-sm">Add Line Item</button>
          </div>
          <datalist id="editPOLineItemSuggestions"></datalist>
        </div>

        <div>
          <label for="editPONetAmount" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Net Amount (<span data-currency-symbol>€</span>) *</label>
          <input type="number" id="editPONetAmount" class="form-control" placeholder="0.00" step="0.01" min="0" inputmode="decimal" style="width: 100%;" required>
        </div>

        <div>
          <label for="editPOVatRate" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">VAT Rate</label>
          <select id="editPOVatRate" class="form-select" style="width: 100%;">
            <option value="" disabled selected>Loading VAT rates...</option>
          </select>
        </div>

        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span>VAT Amount:</span>
            <strong><span data-currency-symbol>€</span><span id="editPOVatAmount">0.00</span></strong>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>Total Amount:</span>
            <strong style="font-size: 1.1rem;"><span data-currency-symbol>€</span><span id="editPOTotalAmount">0.00</span></strong>
          </div>
        </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeEditPOModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Create Purchase Order Modal -->
  <div id="createPOModal" class="modal" style="display:none;">
    <div class="modal-dialog modal-dialog-scrollable" style="max-width: 600px;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create Purchase Order</h5>
          <button type="button" class="btn-close" aria-label="Close" onclick="closeCreatePOModal()"></button>
        </div>
        <form id="poForm">
          <div class="modal-body" style="display: flex; flex-direction: column; gap: 1rem;">
        <div>
          <label for="poSupplier" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Supplier *</label>
          <input type="text" id="poSupplierSearch" class="form-control" placeholder="Type to search suppliers..." style="width: 100%;" autocomplete="off">
          <input type="hidden" id="poSupplier" required>
          <div id="poSupplierDropdown" style="display: none; position: absolute; background: white; border: 1px solid #ddd; border-radius: 4px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 8px rgba(0,0,0,0.1);"></div>
        </div>

        <div>
          <label for="poSite" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Site *</label>
          <select id="poSite" class="form-select" style="width: 100%;" required>
            <option value="">Select Site</option>
          </select>
        </div>

        <div>
          <label for="poLocation" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Location *</label>
          <select id="poLocation" class="form-select" style="width: 100%;" required disabled>
            <option value="">Select Location</option>
          </select>
        </div>

        <div>
          <label for="poStage" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Stage *</label>
          <select id="poStage" class="form-select" style="width: 100%;" required>
            <option value="">Select Stage</option>
          </select>
        </div>

        <div>
          <label for="poDate" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">PO Date *</label>
          <input type="date" id="poDate" class="form-control" style="width: 100%;" required>
        </div>

        <div>
          <div class="field-with-toggle" style="margin-top: 0;">
            <label for="poDescription" style="margin: 0; font-weight: 500;">Description</label>
            <button type="button" id="poToggleLineItems" class="btn btn-outline-secondary btn-sm">Add Line Items</button>
          </div>
          <textarea id="poDescription" class="form-control" placeholder="Enter description" rows="3" style="width: 100%;"></textarea>
        </div>

        <div id="poLineItemsSection" class="line-items-section" style="display: none;">
          <div class="table-responsive">
            <table class="table table-sm line-items-table">
            <thead>
              <tr>
                <th class="line-item-label">Description</th>
                <th class="line-item-label-small text-right" style="width:90px;">Qty</th>
                <th class="line-item-label-small">Unit</th>
                <th class="line-item-label-small text-right" style="width:120px;">Unit Cost</th>
                <th class="line-item-label-small text-right" style="width:120px;">Total</th>
                <th style="width:60px;"></th>
              </tr>
            </thead>
            <tbody id="poLineItemsBody"></tbody>
            </table>
          </div>
          <div class="line-items-actions">
            <button type="button" id="poAddLineItem" class="btn btn-outline-secondary btn-sm">Add Line Item</button>
          </div>
          <datalist id="poLineItemSuggestions"></datalist>
        </div>

        <div>
          <label for="poNetAmount" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">Net Amount (<span data-currency-symbol>€</span>) *</label>
          <input type="number" id="poNetAmount" class="form-control" placeholder="0.00" step="0.01" min="0" inputmode="decimal" style="width: 100%;" required>
        </div>

        <div>
          <label for="poVatRate" style="display: block; margin-bottom: 0.25rem; font-weight: 500;">VAT Rate</label>
          <select id="poVatRate" class="form-select" style="width: 100%;">
            <option value="" disabled selected>Loading VAT rates...</option>
          </select>
        </div>

        <div style="background: #f8f9fa; padding: 1rem; border-radius: 4px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span>VAT Amount:</span>
            <strong><span data-currency-symbol>€</span><span id="poVatAmount">0.00</span></strong>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>Total Amount:</span>
            <strong style="font-size: 1.1rem;"><span data-currency-symbol>€</span><span id="poTotalAmount">0.00</span></strong>
          </div>
        </div>

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeCreatePOModal()">Cancel</button>
            <button type="submit" class="btn btn-primary">Create Purchase Order</button>
          </div>
        </form>
      </div>
    </div>
  </div>

</main>

<%- include('partials/footer', { scripts: ['/ui.js', '/pdf-utils.js', 'dashboard.js'], includeNavScript: true }) %>
