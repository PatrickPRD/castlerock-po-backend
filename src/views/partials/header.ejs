<body>
<nav id="mainHeaderNav" class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
  <div class="container-fluid px-4">
    <a class="navbar-brand d-flex align-items-center" href="dashboard.html">
      <img id="headerBrandImage" src="/assets/Logo.png" alt="Castlerock Homes" height="40" class="me-3">
      <span id="headerBrandText" class="fw-semibold text-white" style="display:none;"></span>
    </a>

    <% if (typeof showNav === 'undefined' || showNav !== false) { %>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav" aria-controls="mainNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item" id="purchaseOrdersNavItem">
            <a class="nav-link px-3" href="dashboard.html" id="purchaseOrdersNavLink">
              <i class="bi bi-receipt me-1"></i><span id="purchaseOrdersText">Purchase Orders</span>
            </a>
          </li>

          <li class="nav-item dropdown" data-roles="super_admin">
            <a class="nav-link dropdown-toggle px-3" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-gear-fill me-1"></i>Admin
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="users.html">
                <i class="bi bi-people me-2"></i>Users
              </a></li>
              <li><a class="dropdown-item" href="workers.html">
                <i class="bi bi-person-badge me-2"></i>Workers
              </a></li>
              <li><a class="dropdown-item" href="locations.html">
                <i class="bi bi-geo-alt me-2"></i>Locations
              </a></li>
              <li><a class="dropdown-item" href="sites.html">
                <i class="bi bi-pin-map me-2"></i>Sites
              </a></li>
              <li><a class="dropdown-item" href="stages.html">
                <i class="bi bi-list-check me-2"></i>Stages
              </a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="location-spread.html">
                <i class="bi bi-diagram-3 me-2"></i>Location Spread
              </a></li>
              <li><a class="dropdown-item" href="backup-management.html">
                <i class="bi bi-database me-2"></i>Backup Management
              </a></li>
              <li><a class="dropdown-item" href="application-settings.html">
                <i class="bi bi-palette me-2"></i>Application Settings
              </a></li>
            </ul>
          </li>

          <li class="nav-item dropdown" data-roles="super_admin">
            <a class="nav-link dropdown-toggle px-3" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-bar-chart-fill me-1"></i>Reports
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="location-report.html">
                <i class="bi bi-pin-map-fill me-2"></i>By Location
              </a></li>
              <li><a class="dropdown-item" href="supplier-report.html">
                <i class="bi bi-building me-2"></i>By Supplier
              </a></li>
              <li><a class="dropdown-item" href="invoice-report.html">
                <i class="bi bi-receipt-cutoff me-2"></i>Invoices
              </a></li>
            </ul>
          </li>

          <li class="nav-item dropdown ms-3">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-person-circle"></i>
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li><a class="dropdown-item text-danger" href="#" onclick="logout(); return false;">
                <i class="bi bi-box-arrow-right me-2"></i>Logout
              </a></li>
            </ul>
          </li>
        </ul>
      </div>
    <% } %>
  </div>
</nav>

<script>
  const BRANDING_EVENT_KEY = 'headerBrandingVersion';
  const BRANDING_CHANNEL_NAME = 'application-settings-updates';

  // Handle Purchase Orders nav item visibility and text based on current page
  (function() {
    const currentPage = window.location.pathname.split('/').pop();
    const navItem = document.getElementById('purchaseOrdersNavItem');
    const navText = document.getElementById('purchaseOrdersText');
    
    if (currentPage === 'dashboard.html' || currentPage === '') {
      // Hide on dashboard
      if (navItem) navItem.style.display = 'none';
    } else if (currentPage === 'suppliers.html') {
      // Change text on suppliers page
      if (navText) navText.textContent = 'Back to Purchase Orders';
    }
  })();

  function applyHeaderBrandingSettings(settings) {
    const nav = document.getElementById('mainHeaderNav');
    const logoImage = document.getElementById('headerBrandImage');
    const logoText = document.getElementById('headerBrandText');

    if (nav && settings.header_color) {
      nav.classList.remove('bg-dark');
      nav.style.backgroundColor = settings.header_color;
    }

    if (!logoImage || !logoText) return;

    if (settings.header_logo_mode === 'text') {
      logoImage.style.display = 'none';
      logoText.style.display = 'inline';
      logoText.textContent = settings.header_logo_text || 'Castlerock Homes';
    } else {
      logoText.style.display = 'none';
      logoImage.style.display = 'inline-block';
      logoImage.src = settings.logo_path || '/assets/Logo.png';
    }
  }

  async function refreshHeaderBranding() {
    const res = await fetch('/settings/public', { cache: 'no-store' });
    if (!res.ok) return;
    const settings = await res.json();
    applyHeaderBrandingSettings(settings);
  }

  // Apply global header branding settings
  (async function() {
    try {
      await refreshHeaderBranding();

      window.addEventListener('storage', (event) => {
        if (event.key === BRANDING_EVENT_KEY) {
          refreshHeaderBranding().catch(() => {});
        }
      });

      if ('BroadcastChannel' in window) {
        const brandingChannel = new BroadcastChannel(BRANDING_CHANNEL_NAME);
        brandingChannel.onmessage = () => {
          refreshHeaderBranding().catch(() => {});
        };
      }
    } catch (_) {
      // Keep defaults if branding settings cannot be loaded
    }
  })();
</script>

