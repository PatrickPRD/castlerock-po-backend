<%- include('partials/head', { pageTitle: 'Backup Management', styles: ['admin.css'] }) %>
<%- include('partials/header', { pageTitle: 'Backup Management' }) %>

<main class="container mt-4">
  
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h3 class="mb-0"><i class="bi bi-database me-2"></i>Database Backups</h3>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-primary" onclick="createBackup()">
          <i class="bi bi-download me-1"></i> Create Backup
        </button>
        <button class="btn btn-sm btn-success" onclick="createAdvancedBackup()" title="Create secure backup with validation">
          <i class="bi bi-shield-check me-1"></i> Advanced Backup
        </button>
        <button class="btn btn-sm btn-secondary" onclick="openUploadModal()">
          <i class="bi bi-upload me-1"></i> Upload Backup
        </button>
        <button class="btn btn-sm btn-danger" onclick="openResetModal()">
          <i class="bi bi-exclamation-triangle me-1"></i> Reset App
        </button>
      </div>
    </div>
    
    <div class="card-body">
      <div class="alert alert-info">
        <i class="bi bi-info-circle me-2"></i>
        <strong>Note:</strong> Backups include all POs, invoices, sites, locations, and suppliers. User accounts are excluded.
      </div>
      
      <div id="loadingSpinner" class="text-center py-5" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading backups...</p>
      </div>
      
      <div id="backupsTable">
        <table class="table table-hover">
          <thead>
            <tr>
              <th>Filename</th>
              <th>Format</th>
              <th>Created</th>
              <th>Size</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="backupsTableBody">
            <tr>
              <td colspan="5" class="text-center text-muted py-4">
                No backups found. Create your first backup above.
              </td>
            </tr>
          </tbody>
        </table>
        
        <!-- Pagination Controls -->
        <div id="paginationControls" class="d-flex justify-content-between align-items-center mt-3" style="display: none !important;">
          <div id="paginationInfo" class="text-muted">
            Showing <span id="paginationStart">0</span> to <span id="paginationEnd">0</span> of <span id="paginationTotal">0</span> backups
          </div>
          <nav>
            <ul class="pagination pagination-sm mb-0" id="paginationButtons">
              <!-- Pagination buttons will be inserted here -->
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

</main>

<!-- Upload Backup Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" style="z-index: 1055;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-upload me-2"></i>Upload Backup</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle me-2"></i>
          <strong>Warning:</strong> Only upload backup files created by this application.
        </div>
        <div class="mb-3">
          <label for="backupFileInput" class="form-label">Select Backup File (.sql or .CTBackup)</label>
          <input type="file" class="form-control" id="backupFileInput" accept=".sql,.CTBackup">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="uploadBackup()">
          <i class="bi bi-upload me-1"></i> Upload
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Restore Preview Modal -->
<div class="modal fade" id="restorePreviewModal" tabindex="-1" style="z-index: 1055;">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title"><i class="bi bi-binoculars me-2"></i>Restore Preview</h5>
        <button type="button" class="btn-close btn-close-white" id="closeRestorePreviewBtn" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="validationSpinner" class="text-center py-5" style="display: none;">
          <div class="mb-3">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
          <p class="fw-bold">Analyzing backup contents...</p>
          <div class="progress mt-3" style="height: 6px;">
            <div
              id="analysisProgressBar"
              class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
              style="width: 0%"
              role="progressbar"
              aria-valuenow="0"
              aria-valuemin="0"
              aria-valuemax="100"
            ></div>
          </div>
          <small id="analysisMeta" class="text-muted mt-2 d-block">Validating backup structure...</small>
        </div>
        
        <div id="validationContent" style="display: none;">
          <p class="mb-2"><strong>Backup File:</strong></p>
          <p id="previewFilename" class="font-monospace bg-light p-2 rounded mb-3"></p>

          <div id="restoreProgressSection" class="alert alert-info border-info" style="display: none;">
            <div class="mb-3">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <strong id="restoreProgressStatus">Initializing restore...</strong>
                  <small id="restorePhase" class="d-block text-muted">Phase: Starting</small>
                </div>
                <span id="restoreElapsedTime" class="font-monospace fw-bold">00:00</span>
              </div>
              <div class="progress" role="progressbar" aria-label="Restore progress" aria-valuemin="0" aria-valuemax="100" style="height: 24px;">
                <div
                  id="restoreProgressBar"
                  class="progress-bar progress-bar-striped progress-bar-animated bg-info"
                  style="width: 0%"
                  aria-valuenow="0"
                  role="progressbar"
                  aria-valuenow="0"
                  aria-valuemin="0"
                  aria-valuemax="100"
                >
                  <span id="restorePercent">0%</span>
                </div>
              </div>
              <small class="text-muted mt-2 d-block">
                <i class="bi bi-info-circle me-1"></i>
                Restoring database backup. Please keep this page open.
              </small>
            </div>
            <div id="restoreStats" class="row g-2 mt-2" style="font-size: 0.9rem;">
              <div class="col-md-4">
                <span class="text-muted">Records Restored:</span>
                <br><strong id="restoreRecordCount">0</strong>
              </div>
              <div class="col-md-4">
                <span class="text-muted">Tables:</span>
                <br><strong><span id="restoreTableCount">0</span>/0</strong>
              </div>
              <div class="col-md-4">
                <span class="text-muted">Est. Time Left:</span>
                <br><strong id="restoreTimeLeft">-- </strong>
              </div>
            </div>
          </div>
          
          <div id="validationWarnings" style="display: none;">
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>
              <strong>Warnings:</strong>
              <ul id="warningsList" class="mb-0 mt-2"></ul>
            </div>
          </div>
          
          <div id="validationErrors" style="display: none;">
            <div class="alert alert-danger">
              <i class="bi bi-exclamation-octagon-fill me-2"></i>
              <strong>Errors:</strong>
              <ul id="errorsList" class="mb-0 mt-2"></ul>
            </div>
          </div>
          
          <div id="tablesSummary">
            <p class="mb-2"><strong>Tables to Restore:</strong></p>
            <div id="tablesList" class="table-responsive">
              <table class="table table-sm table-bordered">
                <thead class="table-light">
                  <tr>
                    <th>Table Name</th>
                    <th class="text-end">Records</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="tablesBody">
                </tbody>
              </table>
            </div>
          </div>
          
          <div id="sqlFileInfo" style="display: none;" class="alert alert-info">
            <i class="bi bi-info-circle me-2"></i>
            <strong>SQL Backup:</strong> This is a direct SQL export. Full validation is not available, but all tables will be reset to the backup state.
          </div>
          
          <div class="alert alert-danger mt-3">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>WARNING:</strong> This will delete all existing data and replace it with the backup data.
            <ul class="mb-0 mt-2">
              <li>All current POs, invoices, and data will be lost</li>
              <li>User accounts will NOT be affected</li>
              <li>This action CANNOT be undone</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="cancelRestorePreviewBtn" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmPreviewBtn" onclick="proceedWithRestore()">
          <i class="bi bi-arrow-clockwise me-1"></i> Yes, Restore This Backup
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Restore Confirmation Modal -->
<div class="modal fade" id="restoreModal" tabindex="-1" style="z-index: 1055;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Restore Backup</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>WARNING:</strong> This will delete all existing data and replace it with the backup data.
          <ul class="mb-0 mt-2">
            <li>All current POs, invoices, and data will be lost</li>
            <li>User accounts will NOT be affected</li>
            <li>This action CANNOT be undone</li>
          </ul>
        </div>
        <p class="mb-2"><strong>Restore from:</strong></p>
        <p id="restoreFilename" class="font-monospace bg-light p-2 rounded"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="confirmRestore()">
          <i class="bi bi-arrow-clockwise me-1"></i> Restore Backup
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Reset App Modal -->
<div class="modal fade" id="resetModal" tabindex="-1" style="z-index: 1055;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-exclamation-octagon me-2"></i>Reset Application</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger" style="border-color: #dc3545;">
          <i class="bi bi-exclamation-octagon-fill me-2"></i>
          <strong>EXTREME WARNING:</strong> This cannot be undone!
          <ul class="mb-0 mt-2">
            <li>All data will be permanently deleted</li>
            <li>All users will be removed (including you)</li>
            <li>You will be logged out immediately</li>
            <li>The application will return to setup wizard</li>
          </ul>
        </div>
        <div class="mb-3">
          <label for="resetConfirmText" class="form-label">
            Type <strong>RESET TO WIZARD</strong> to confirm:
          </label>
          <input 
            type="text" 
            class="form-control font-monospace" 
            id="resetConfirmText" 
            placeholder="RESET TO WIZARD"
            autocomplete="off"
          >
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmResetBtn" onclick="confirmReset()" disabled>
          <i class="bi bi-exclamation-octagon me-1"></i> Yes, Reset Everything
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backup Limit Warning Modal -->
<div class="modal fade" id="backupLimitModal" tabindex="-1" style="z-index: 1055;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title"><i class="bi bi-exclamation-triangle me-2"></i>Backup Limit Reached</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-warning">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>Maximum backups (20) reached!</strong>
        </div>
        <p class="mb-2">Creating a new backup will automatically delete the oldest backup:</p>
        <p id="oldestBackupName" class="font-monospace bg-light p-2 rounded"></p>
        <p class="mb-0"><strong>Do you want to continue?</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-warning" onclick="proceedWithBackup()">
          <i class="bi bi-download me-1"></i> Yes, Create Backup
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Backup Confirmation Modal -->
<div class="modal fade" id="deleteBackupModal" tabindex="-1" style="z-index: 1055;">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title"><i class="bi bi-trash me-2"></i>Delete Backup</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <strong>Are you sure?</strong> This cannot be undone.
        </div>
        <p class="mb-2">Backup file:</p>
        <p id="deleteBackupFilename" class="font-monospace bg-light p-2 rounded mb-0"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" onclick="proceedWithDelete()">
          <i class="bi bi-trash me-1"></i> Yes, Delete Backup
        </button>
      </div>
    </div>
  </div>
</div>

<%- include('partials/footer', { scripts: ['/ui.js', 'backup-management.js'], includeNavScript: true }) %>
